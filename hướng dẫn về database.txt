-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.Claim (
  Claim_id integer GENERATED ALWAYS AS IDENTITY NOT NULL,
  Coverage_id integer NOT NULL,
  Event_Date timestamp without time zone,
  Request_Date timestamp without time zone NOT NULL,
  Claim_Status character varying NOT NULL,
  Requested_Amount numeric,
  Approved_Amount numeric,
  Description character varying,
  Payment_Date timestamp without time zone,
  CONSTRAINT Claim_pkey PRIMARY KEY (Claim_id),
  CONSTRAINT fk_claim_coverage FOREIGN KEY (Coverage_id) REFERENCES public.Coverage(Coverage_ID)
);
CREATE TABLE public.Coverage (
  Coverage_ID integer GENERATED ALWAYS AS IDENTITY NOT NULL,
  Policy_ID integer NOT NULL,
  Party_ID integer NOT NULL,
  Product_id integer NOT NULL,
  Sum_Asured numeric NOT NULL,
  Phí_bảo_hiểm(Premium) numeric,
  CONSTRAINT Coverage_pkey PRIMARY KEY (Coverage_ID),
  CONSTRAINT fk_coverage_policy FOREIGN KEY (Policy_ID) REFERENCES public.Policy(Policy_ID),
  CONSTRAINT fk_coverage_party FOREIGN KEY (Party_ID) REFERENCES public.Party(Party_ID),
  CONSTRAINT fk_coverage_product FOREIGN KEY (Product_id) REFERENCES public.Product(Product_id)
);
CREATE TABLE public.Party (
  Party_ID integer GENERATED ALWAYS AS IDENTITY NOT NULL,
  Name character varying NOT NULL,
  Date_of_birth timestamp without time zone NOT NULL,
  Gender USER-DEFINED NOT NULL,
  CCCD smallint,
  Location character varying NOT NULL,
  Phone_num smallint,
  Email character varying,
  Role character varying,
  CONSTRAINT Party_pkey PRIMARY KEY (Party_ID)
);
CREATE TABLE public.Policy (
  Policy_ID integer GENERATED ALWAYS AS IDENTITY NOT NULL,
  Policy_Number smallint NOT NULL,
  Party_ID integer NOT NULL,
  Ngày_hiệu_lực timestamp without time zone NOT NULL,
  Ngày_đáo_hạn timestamp without time zone,
  Status character varying NOT NULL,
  Kỳ_đóng_phí timestamp without time zone,
  Campaign_Code character varying NOT NULL,
  CONSTRAINT Policy_pkey PRIMARY KEY (Policy_ID),
  CONSTRAINT fk_policy_party FOREIGN KEY (Party_ID) REFERENCES public.Party(Party_ID)
);
CREATE TABLE public.Product (
  Product_id integer GENERATED ALWAYS AS IDENTITY NOT NULL,
  Product_Code character varying NOT NULL,
  Product_Name character varying NOT NULL,
  Product_Type character varying NOT NULL,
  Status character varying NOT NULL,
  Issure_Date date NOT NULL,
  End_Date date,
  CONSTRAINT Product_pkey PRIMARY KEY (Product_id)
);
CREATE TABLE public.Transaction (
  Transaction_ID integer GENERATED ALWAYS AS IDENTITY NOT NULL,
  Policy_ID integer NOT NULL,
  Loại giao dịch character varying NOT NULL,
  Số tiền numeric NOT NULL,
  Ngày giao dịch timestamp without time zone NOT NULL,
  CONSTRAINT Transaction_pkey PRIMARY KEY (Transaction_ID),
  CONSTRAINT fk_transaction_policy FOREIGN KEY (Policy_ID) REFERENCES public.Policy(Policy_ID)
);
CREATE TABLE public.annual_budget (
  annual_budget_id integer NOT NULL DEFAULT nextval('annual_budget_annual_budget_id_seq'::regclass),
  department_id integer,
  year integer,
  category text,
  total_amount numeric,
  amount_spent numeric DEFAULT 0,
  amount_remaining numeric DEFAULT (total_amount - amount_spent),
  CONSTRAINT annual_budget_pkey PRIMARY KEY (annual_budget_id),
  CONSTRAINT annual_budget_department_id_fkey FOREIGN KEY (department_id) REFERENCES public.department(department_id)
);
CREATE TABLE public.approval_workflow (
  step_id integer NOT NULL DEFAULT nextval('approval_workflow_step_id_seq'::regclass),
  request_id integer,
  step_number integer,
  approver_id integer,
  status text CHECK (status = ANY (ARRAY['Pending'::text, 'Approved'::text, 'Rejected'::text, 'Skipped'::text])),
  comment text,
  action_timestamp timestamp without time zone,
  CONSTRAINT approval_workflow_pkey PRIMARY KEY (step_id),
  CONSTRAINT approval_workflow_request_id_fkey FOREIGN KEY (request_id) REFERENCES public.request(request_id),
  CONSTRAINT approval_workflow_approver_id_fkey FOREIGN KEY (approver_id) REFERENCES public.employee(employee_id)
);
CREATE TABLE public.budget_item (
  item_id integer NOT NULL DEFAULT nextval('budget_item_item_id_seq'::regclass),
  request_id integer,
  item_name text NOT NULL,
  description text,
  requested_amount numeric NOT NULL,
  vendor_quote_link text,
  CONSTRAINT budget_item_pkey PRIMARY KEY (item_id),
  CONSTRAINT budget_item_request_id_fkey FOREIGN KEY (request_id) REFERENCES public.request(request_id)
);
CREATE TABLE public.department (
  department_id integer NOT NULL DEFAULT nextval('department_department_id_seq'::regclass),
  department_name text NOT NULL,
  CONSTRAINT department_pkey PRIMARY KEY (department_id)
);
CREATE TABLE public.document (
  document_id integer NOT NULL DEFAULT nextval('document_document_id_seq'::regclass),
  request_id integer,
  file_name text,
  file_path text,
  uploaded_by_id integer,
  upload_timestamp timestamp without time zone DEFAULT now(),
  CONSTRAINT document_pkey PRIMARY KEY (document_id),
  CONSTRAINT document_request_id_fkey FOREIGN KEY (request_id) REFERENCES public.request(request_id),
  CONSTRAINT document_uploaded_by_id_fkey FOREIGN KEY (uploaded_by_id) REFERENCES public.employee(employee_id)
);
CREATE TABLE public.employee (
  employee_id integer NOT NULL DEFAULT nextval('employee_employee_id_seq'::regclass),
  full_name text NOT NULL,
  email text,
  department_id integer,
  manager_id integer,
  role text,
  CONSTRAINT employee_pkey PRIMARY KEY (employee_id),
  CONSTRAINT employee_department_id_fkey FOREIGN KEY (department_id) REFERENCES public.department(department_id),
  CONSTRAINT employee_manager_id_fkey FOREIGN KEY (manager_id) REFERENCES public.employee(employee_id)
);
CREATE TABLE public.policy_rule (
  rule_id integer NOT NULL DEFAULT nextval('policy_rule_rule_id_seq'::regclass),
  rule_name text NOT NULL,
  rule_value numeric,
  description text,
  CONSTRAINT policy_rule_pkey PRIMARY KEY (rule_id)
);
CREATE TABLE public.request (
  request_id integer NOT NULL DEFAULT nextval('request_request_id_seq'::regclass),
  request_code text NOT NULL UNIQUE,
  title text NOT NULL,
  requester_id integer,
  department_id integer,
  description text,
  status text CHECK (status = ANY (ARRAY['Draft'::text, 'Pending'::text, 'Approved'::text, 'Rejected'::text, 'Completed'::text])),
  created_date timestamp without time zone DEFAULT now(),
  total_estimated_amount numeric DEFAULT 0,
  CONSTRAINT request_pkey PRIMARY KEY (request_id),
  CONSTRAINT request_requester_id_fkey FOREIGN KEY (requester_id) REFERENCES public.employee(employee_id),
  CONSTRAINT request_department_id_fkey FOREIGN KEY (department_id) REFERENCES public.department(department_id)
);



[Hình ảnh]
Kiến trúc Database cho "Sales Activity Workflow System"
1. Bảng Employee (Nhân viên)
Bảng này lưu trữ thông tin của tất cả những người dùng hệ thống (Sales, Sếp ATO, Marketing, Finance).
- Employee_ID (Khóa chính)
- Full_Name (Tên đầy đủ)
- Email (Dùng để gửi thông báo)
- Department_ID (Khóa ngoại - Trỏ đến bảng Department)
- Manager_ID (Khóa ngoại - Tự trỏ đến Employee_ID của sếp)
- Role (Vai trò, vd: 'Sales', 'Sales_Manager', 'Marketing_Staff', 'Finance_Controller')

2. Bảng Department (Phòng ban)
Bảng này định nghĩa các phòng ban sẽ tham gia vào quy trình.
- Department_ID (Khóa chính)
- Department_Name (Tên phòng ban, vd: "ATO - Vùng 1", "Marketing", "Tài chính")

3. Bảng Annual_Budget ("Cái ví tổng" đã duyệt)
Đây là bảng "sổ cái" mà bộ phận Tài chính dùng để kiểm tra ngân sách.
- Annual_Budget_ID (Khóa chính)
- Department_ID (Khóa ngoại - "Ví" này của bộ phận nào? Vd: của ATO)
- Year (Năm, vd: 2026)
- Category (Hạng mục, vd: "Hội thảo khách hàng", "Thi đua bán hàng")
- Total_Amount (Tổng tiền được duyệt, vd: 5,000,000,000)
- Amount_Spent (Số tiền đã tiêu)
- Amount_Remaining (Số tiền còn lại - AI Agent sẽ đọc số này)

4. Bảng Activity_Request (Đề xuất Hoạt động)
Đây là bảng "giao dịch" chính, lưu mỗi "yêu cầu xin kinh phí" của Sales.
- Request_ID (Khóa chính)
- Request_Name (Tên sự kiện, vd: "Hội thảo Sống Khỏe TPHCM 12/2026")
- Requestor_ID (Khóa ngoại - Trỏ đến Employee_ID của người tạo)
- Request_Date (Ngày tạo đề xuất)
- Event_Date (Ngày dự kiến tổ chức)
- Total_Budget_Requested (Tổng kinh phí xin)
- Status (Trạng thái, vd: "Bản nháp", "Chờ sếp ATO duyệt", "Chờ Marketing duyệt", "Chờ Tài chính duyệt", "Đã duyệt", "Bị từ chối")
- Annual_Budget_ID (Khóa ngoại - Trỏ đến "ví tổng" trong bảng Annual_Budget)

5. Bảng Budget_Item (Chi tiết các Hạng mục chi)
Bảng này lưu các dòng chi tiết trong file Excel dự toán của Sales Team. Một Activity_Request sẽ có nhiều Budget_Item.
- Item_ID (Khóa chính)
- Request_ID (Khóa ngoại - Trỏ đến Activity_Request)
- Item_Name (Hạng mục, vd: "Thuê địa điểm", "Tea-break", "Quà tặng")
- Description (Mô tả chi tiết)
- Requested_Amount (Số tiền xin cho hạng mục này, vd: 10,000,000)
- Vendor_Quote_Link (Link đến báo giá của nhà cung cấp, nếu có)

6. Bảng Document (Tài liệu đính kèm)
Nơi lưu trữ các file mềm (PowerPoint kế hoạch, Excel dự toán...).
- Document_ID (Khóa chính)
- Request_ID (Khóa ngoại - Trỏ đến Activity_Request)
- File_Name (Tên file, vd: "KeHoach_HCM.pptx")
- File_Path (Đường dẫn lưu file trên server/cloud)
- Uploaded_By_ID (Khóa ngoại - Trỏ đến Employee_ID)

7. Bảng Approval_Workflow (Lịch sử Luồng Phê duyệt)
Đây là bảng "ghi lại nhật ký" của toàn bộ quy trình, và là bảng quan trọng nhất cho AI Agent của bạn.
- Step_ID (Khóa chính)
- Request_ID (Khóa ngoại - Trỏ đến Activity_Request)
- Step_Number (Thứ tự bước, vd: 1, 2, 3)
- Approver_ID (Khóa ngoại - Trỏ đến Employee_ID của người được gán duyệt)
- Status (Trạng thái của bước này: "Pending", "Approved", "Rejected")
- Comment (Phần ghi chú lý do, vd: "Từ chối do vượt định mức quà tặng")
- Action_Timestamp (Thời điểm sếp nhấn nút duyệt/từ chối)

8. Bảng Policy_Rule (Quy định/Định mức của Công ty)
Đây là "bộ não" tham chiếu cho AI Agent khi tiền thẩm định.
- Rule_ID (Khóa chính)
- Rule_Name (Tên quy định, vd: "Định mức quà tặng", "Định mức thuê hội trường")
- Rule_Value (Giá trị, vd: "300000")
- Description (Mô tả, vd: "Chi phí quà tặng không quá 300.000 VNĐ/khách")

---
AI Agent của sẽ "sống" trong hệ thống này như thế nào?
1. AI làm Co-pilot (Hỗ trợ tạo): Khi Sales tạo Activity_Request mới, AI sẽ đọc các request cũ trong bảng này và bảng Budget_Item để gợi ý Total_Budget_Requested.
2. AI làm Gatekeeper (Tiền thẩm định): Khi Sales nhấn "Submit" (thay đổi Status của Activity_Request):
  - AI Agent đọc Total_Budget_Requested và so sánh với Amount_Remaining trong bảng Annual_Budget.
  - AI Agent đọc từng dòng Budget_Item và so sánh với Rule_Value trong bảng Policy_Rule.
  - AI Agent scan file trong Document.File_Path để tìm logo.
  - Nếu có lỗi, AI Agent cập nhật Activity_Request.Status = "Bị từ chối" và ghi lỗi vào bảng Approval_Workflow.Comment mà không cần chờ sếp.
3. AI làm Analyst (Tóm tắt): Nếu qua bước 2, AI Agent sẽ gửi tóm tắt (từ bảng Activity_Request) cho sếp (Approver_ID trong bảng Approval_Workflow).
4. AI làm Orchestrator (Điều phối): Khi tất cả các bước trong Approval_Workflow cho một Request_ID đều là "Approved", AI Agent sẽ tự động gọi API của hệ thống ERP/Kế toán.
Có thể bạn thắc mắc
1. Về Manager_ID (trong bảng Employee)
- Câu trả lời: Chính xác, nó nằm trong bảng Employee luôn.
- Giải thích: Đây được gọi là mối quan hệ tự tham chiếu (self-referencing relationship). Một "Manager" (Quản lý) cũng là một "Employee" (Nhân viên). Bảng này lưu thông tin của tất cả nhân viên, từ nhân viên mới cho đến Tổng giám đốc.
- Ví dụ:
  - Nhân viên Nguyễn Văn A có Employee_ID = 10.
  - Sếp của anh A là chị Trần Thị B có Employee_ID = 5.
  - Trong dòng dữ liệu của "Nguyễn Văn A" (ID: 10), cột Manager_ID sẽ có giá trị là 5.
  - Hệ thống có thể dựa vào đây để tự động tìm ra sếp của người gửi đề xuất.

2. Về Requestor_ID (trong bảng Activity_Request)
- Câu trả lời: Bạn hiểu chính xác 100%. Nó là Khóa ngoại (Foreign Key) trỏ đến Employee_ID.
- Giải thích: Khi một nhân viên tạo một "Đề xuất hoạt động", hệ thống cần biết ai là người tạo.
- Ví dụ:
  - Nhân viên Nguyễn Văn A (ID: 10) đăng nhập và tạo một đề xuất mới.
  - Hệ thống sẽ tạo một dòng mới trong bảng Activity_Request (ví dụ Request_ID = 101) và tự động điền Requestor_ID = 10.

3. Về Approver_ID (trong bảng Approval_Workflow)
- Câu trả lời: Nó giống hệt như Requestor_ID. Nó cũng là Khóa ngoại (Foreign Key) trỏ đến Employee_ID.
- Giải thích: Bảng Approval_Workflow lưu lại các bước mà một đề xuất phải đi qua. Mỗi bước cần một (hoặc nhiều) người duyệt. Approver_ID chính là người được gán trách nhiệm duyệt cho bước đó.
- Ví dụ:
  - Đề xuất 101 của anh A (ID: 10) cần 3 bước duyệt.
  - Hệ thống sẽ tự động tạo 3 dòng trong bảng Approval_Workflow:
    1. Request_ID = 101, Step_Number = 1, Approver_ID = 5 (Chị B - Sếp trực tiếp)
    2. Request_ID = 101, Step_Number = 2, Approver_ID = 22 (Anh C - Trưởng phòng Marketing)
    3. Request_ID = 101, Step_Number = 3, Approver_ID = 35 (Chị D - Trưởng phòng Tài chính)
Summary: Bảng Employee là bảng "danh bạ" trung tâm. Các bảng khác chỉ cần dùng Employee_ID để chỉ định "vai trò" của nhân viên đó trong một nghiệp vụ cụ thể (là người yêu cầu, người phê duyệt, hay người quản lý).
4. Trường tùy chọn (Nullable):
- Budget_Item.Vendor_Quote_Link: Trường này nên cho phép NULL (vì có thể có hạng mục chi không cần báo giá).
- Employee.Manager_ID: Trường này cũng nên cho phép NULL, vì người cao nhất (ví dụ: Tổng giám đốc) sẽ không có sếp (Manager_ID = NULL).

5. Vấn đề: Đang để Rule_Value là DECIMAL. Điều này có nghĩa là bạn chỉ có thể lưu các quy định về con số (ví dụ: định mức 300.000 VNĐ). 
Tình huống thực tế: Quy định của công ty có thể không phải là số. Ví dụ:
  - Rule_Name = "Logo bắt buộc", Rule_Value = "Hanwha_Logo_2025_Final.png" (Đây là text)
  - Rule_Name = "Email Marketing phê duyệt", Rule_Value = "marketing@hanwha.com" (Đây là text)
  - Rule_Name = "Hạng mục cấm", Rule_Value = "rượu bia, thuốc lá" (Đây là text)
  Giải pháp: Hãy đổi kiểu dữ liệu của Rule_Value từ DECIMAL thành VARCHAR(255) (hoặc TEXT nếu quy định quá dài).

Vấn đề băn khoăn
Role, Status, Category: Việc dùng ENUM là chấp nhận được. Tuy nhiên, trong các hệ thống lớn, người ta thường sẽ tạo thêm các "bảng tra cứu" (lookup tables) riêng (ví dụ: bảng Role, bảng Status_Type) để dễ dàng thêm/bớt các vai trò, trạng thái trong tương lai mà không cần sửa cấu trúc database. Nhưng với quy mô dự án này, dùng ENUM cho đơn giản cũng không sao.

 Tái cấu trúc phần "Vai trò của AI Agent" (Tập trung vào Lợi ích)
Vai trò & Lợi ích của AI Agent:
1. AI làm Co-pilot (Trợ lý Khởi tạo):
  - Hiện trạng: Sales mất nhiều giờ để lập dự toán thủ công.
  - Giải pháp: AI tự động gợi ý tổng kinh phí (Total_Budget_Requested) dựa trên dữ liệu lịch sử.
  - Lợi ích: Rút ngắn thời gian lập kế hoạch từ vài ngày xuống còn vài phút.
2. AI làm Gatekeeper (Người gác cổng Thông minh):
  - Hiện trạng: Quy trình "ping-pong" (gửi qua gửi lại) khi sếp/Tài chính phát hiện lỗi, tốn 3-5 ngày làm việc.
  - Giải pháp: AI tự động "tiền thẩm định" đề xuất (so sánh với Annual_Budget và Policy_Rule) trong 30 giây.
  - Lợi ích: Phát hiện và yêu cầu sửa lỗi ngay lập tức. Loại bỏ 100% thời gian chờ đợi và "ping-pong" lãng phí.
3. AI làm Analyst (Chuyên viên Phân tích):
  - Hiện trạng: Lãnh đạo bận rộn, không có thời gian đọc file kế hoạch 10 trang, dẫn đến "ngâm" hồ sơ.
  - Giải pháp: AI tự động tóm tắt đề xuất thành 3 dòng cô đọng gửi cho sếp.
  - Lợi ích: Giúp lãnh đạo ra quyết định phê duyệt chỉ trong 1 phút.
4. AI làm Orchestrator (Nhạc trưởng Điều phối):
  - Hiện trạng: Kế toán phải nhập liệu thủ công vào hệ thống ERP sau khi được duyệt.
  - Giải pháp: AI tự động kích hoạt API của hệ thống Kế toán.
  - Lợi ích: Loại bỏ hoàn toàn thao tác nhập liệu thủ công, đảm bảo số liệu nhất quán.

Giải thích về các cột NULL và NOT NULL
Employee.Manager_ID (?):
- Lý do: Cho phép NULL.
- Ví dụ: Sẽ có ít nhất một người trong công ty không có sếp, đó là người ở cấp cao nhất (ví dụ: Tổng Giám đốc/CEO). Dòng Employee của người này sẽ có Manager_ID = NULL.
Budget_Item.Vendor_Quote_Link (?):
- Lý do: Cho phép NULL.
- Ví dụ 1 (Hạng mục nhỏ): Hạng mục chi (Item_Name) là "Nước suối và khăn lạnh". Đây là chi phí nhỏ, không cần một báo giá (quote) chính thức dạng link.
- Ví dụ 2 (Báo giá đính kèm): Sales Team đã nhận được báo giá dạng file PDF từ nhà cung cấp. Họ sẽ tải file này lên bảng Document thay vì dán link vào đây.
Policy_Rule.Description (?):
- Lý do: Cho phép NULL.
- Ví dụ: Quy định (Rule) đã quá rõ ràng và không cần mô tả thêm. Ví dụ: Rule_Name = "Định mức quà tặng", Rule_Value = "300000". Tên và giá trị đã tự giải thích, Description có thể để trống.

Quy trình Vận hành của CSDL (How it works)
CSDL này vận hành bằng cách theo dõi một Activity_Request (Đề xuất) đi qua một chuỗi các trạng thái (Status), được kích hoạt bởi các hành động trong Approval_Workflow.
Giai đoạn 0: Cài đặt Hệ thống (Admin & Finance làm 1 lần)
Trước khi mọi thứ bắt đầu, Admin phải thiết lập "luật chơi":
1. Tạo Phòng ban: INSERT vào Department (ví dụ: "ATO - Vùng 1", "Marketing", "Tài chính").
2. Tạo Nhân viên: INSERT vào Employee (ví dụ: tạo "Sales A" gán Department_ID="ATO - Vùng 1", gán Manager_ID="Trưởng ban B").
3. Tạo Quy định: INSERT vào Policy_Rule (ví dụ: Rule_Name="Định mức quà tặng", Rule_Value="300000").
4. Tạo Ngân sách: INSERT vào Annual_Budget (ví dụ: Department_ID="ATO - Vùng 1", Year=2025, Category="Hội thảo khách hàng", Total_Amount=5,000,000,000).
Giai đoạn 1: Khởi tạo Đề xuất (Sales Team)
1. Tạo Đề xuất: Sales Team ("Sales A") đăng nhập.
  - Hệ thống INSERT 1 dòng vào Activity_Request:
    - Request_Name: "Hội thảo Sống Khỏe TPHCM"
    - Requestor_ID: (ID của "Sales A")
    - Total_Budget_Requested: 50,000,000
    - Status: "Bản nháp" (Draft)
    - Annual_Budget_ID: (ID của ví "Hội thảo khách hàng")
    - Campaign_Code: NULL (vì chưa được duyệt)
2. Thêm Chi tiết:
  - Hệ thống INSERT 3 dòng vào Budget_Item (ví dụ: "Thuê địa điểm", "Tea-break", "Quà tặng") trỏ về Request_ID ở trên.
  - Hệ thống INSERT 2 dòng vào Document (ví dụ: file "KeHoach.pdf", file "BaoGia.pdf") trỏ về Request_ID ở trên. Uploaded_By_ID = (ID của "Sales A").
  
Giai đoạn 2: Bắt đầu Luồng Phê duyệt (Sales nhấn "Submit")
1. Cập nhật Trạng thái: Hệ thống UPDATE Activity_Request SET Status = "Chờ duyệt Nấc 1".
2. Tìm Người duyệt: Hệ thống đọc Employee.Manager_ID của "Sales A" để tìm ra "Trưởng ban B".
3. Tạo Task: Hệ thống INSERT 1 dòng vào Approval_Workflow:
  - Request_ID: (ID của đề xuất)
  - Step_Number: 1
  - Approver_ID: (ID của "Trưởng ban B")
  - Status: "Pending" (Đang chờ)

Giai đoạn 3: Phê duyệt (Trưởng ban & các cấp)
1. Trưởng ban B "Duyệt":
  - Hệ thống UPDATE dòng Approval_Workflow (của Step 1) SET Status = "Approved", Action_Timestamp = NOW().
  - Hệ thống tiếp tục tìm Manager_ID của "Trưởng ban B" để ra "Giám đốc vùng C".
  - Hệ thống INSERT dòng Approval_Workflow mới (Step 2) cho "Giám đốc vùng C".
2. Luân chuyển: Quy trình này lặp lại cho đến khi Giám đốc vùng duyệt.
3. Phê duyệt Liên phòng ban: Sau khi Giám đốc vùng (nấc cuối của ATO) duyệt, hệ thống (đã được cấu hình) INSERT 2 dòng Approval_Workflow mới (Step 3 và 4) cho "Sếp Marketing" và "Sếp Tài chính".

Giai đoạn 4: Kết thúc Quy trình
- Kịch bản A: Bị Từ chối (Rejected)
  - "Sếp Tài chính" nhấn "Từ chối".
  - Hệ thống UPDATE dòng Approval_Workflow (của Step 4) SET Status = "Rejected", Comment = "Chi phí quà tặng vượt định mức 300k".
  - Hệ thống UPDATE Activity_Request SET Status = "Bị từ chối".
  - Quy trình dừng lại.
- Kịch bản B: Được Phê duyệt (Approved)
  - Tất cả các bước trong Approval_Workflow đều "Approved".
  - Hệ thống UPDATE Activity_Request SET Status = "Đã duyệt".
  - (Quan trọng) Hệ thống tự động tạo một mã (ví dụ: "HCM_1225") và UPDATE vào Activity_Request.Campaign_Code.
  - (Quan trọng) Hệ thống UPDATE bảng Annual_Budget (nơi có ID tương ứng):
    - Amount_Spent = Amount_Spent + 50,000,000
    - Amount_Remaining = Amount_Remaining - 50,000,000
  - Quy trình hoàn tất.




  [Hình ảnh]
Update mới 
- Dùng một "Mã liên kết" (Linking Key), thường gọi là Mã Chiến dịch (Campaign Code).
Quy trình nghiệp vụ:
1. Tại Vùng 1 (Hệ thống Activity):
  - Khi AI Agent + Sếp duyệt một Activity_Request (ví dụ: Request_ID = 101, "Hội thảo TPHCM"), hệ thống sẽ tự động tạo một Mã Chiến dịch ngắn gọn, ví dụ: HCM_1225.
  - Mã này được gửi cho Sales Team.
2. Tại Vùng 2 (Hệ thống PAS):
  - Khi Sales Team chốt được khách hàng tại sự kiện, họ sẽ nhập hồ sơ khách hàng vào hệ thống PAS.
  - Trong giao diện nhập liệu của PAS, sẽ có một trường bắt buộc gọi là "Nguồn" (Lead Source) hoặc "Mã Chiến dịch" (Campaign Code).
  - Sales Team sẽ nhập HCM_1225 vào trường này cho mọi khách hàng họ chốt được từ sự kiện đó.
3. Tại Vùng 3 (Hệ thống DWH):
  - Hàng đêm (may be hằng Tuần (Theo Batch Time)), DWH sao chép dữ liệu. Giờ đây, nó có thể dễ dàng liên kết:
    - Bảng Chi tiêu (từ Vùng 1) có Mã HCM_1225 = 50 triệu.
    - Bảng Hợp đồng (từ Vùng 2) có 15 hợp đồng với Mã HCM_1225, tổng doanh thu 300 triệu.
  - Kết quả: Có thể tạo báo cáo ROI chính xác: Chiến dịch HCM_1225 chi 50 triệu, thu 300 triệu.
Bổ sung 2 bảng Product và Claim (Bồi thường)
Bảng Product (Sản phẩm):
- Giả sử ban đầu "hard-code" Product_Code (VARCHAR) trong bảng Coverage. Điều này sẽ gây ra lỗi nhập liệu (ví dụ: "SP01" và "sp01" là khác nhau) và không thể lưu tên đầy đủ của sản phẩm.
- Solution: Tạo bảng Product
Bảng Claim (Bồi thường):
- Hệ thống của mình đang có "tiền vào" (Transaction đóng phí) nhưng không có nghiệp vụ "tiền ra" (Bồi thường). Bảng Transaction trước đó chỉ ghi nhận dòng tiền, nó không quản lý quy trình duyệt bồi thường.
- Giải pháp: Thêm bảng Claim.  Khi một Claim được duyệt "Approved", lúc đó mình mới tạo một dòng Transaction (Loại = "Chi trả bồi thường").

Describe chi tiết về 2 bảng Product và Claim
Bảng Product (Sản phẩm)
1.1 Tại sao cần bảng này?
Ban đầuProduct_Code (một đoạn text) vào bảng Coverage. Điều này gây ra 3 vấn đề lớn:
1. Không nhất quán: Người nhập có thể gõ "SP01", "sp01", "SP-01". Máy tính sẽ hiểu đây là 3 sản phẩm khác nhau, gây ra "rác" dữ liệu.
2. Không có thông tin: Mình chỉ có "mã", vậy "tên đầy đủ" của sản phẩm (ví dụ: "Sản phẩm Bảo hiểm Liên kết chung Đồng hành Vững bước") lưu ở đâu?
3. Khó bảo trì: Nếu công ty đổi tên một sản phẩm, mình sẽ phải cập nhật hàng triệu dòng trong bảng Coverage (một bảng khổng lồ).
Giải pháp: Tạo một bảng "sổ cái" (master data) tên là Product để lưu thông tin sản phẩm một lần duy nhất. Bảng Coverage sẽ chỉ tham chiếu đến Product_ID của nó.
Tên cột
Kiểu dữ liệu
Khóa
Description
Product_ID
INTEGER
PK (Khóa chính)
Mã định danh duy nhất của sản phẩm trong hệ thống.
Product_Code
VARCHAR(50)
UNIQUE
Mã nghiệp vụ (ví dụ: "UL01", "CI03"). Đây là mã mà nhân viên hay dùng.
Product_Name
VARCHAR(255)

Tên đầy đủ, chính thức của sản phẩm
Product_Type
VARCHAR(50)

Cực kỳ quan trọng! Dùng để phân loại: "Main" (Sản phẩm chính) hay "Rider" (Sản phẩm bổ trợ).
Status
VARCHAR(50)

Trạng thái sản phẩm: "Active" (Đang bán), "Discontinued" (Ngừng bán)...
Issue_Date
DATE

Ngày sản phẩm này bắt đầu được bán.
End_Date
DATE

Ngày sản phẩm này ngừng bán (có thể NULL)
Bảng Claim (Yêu cầu Bồi thường)
Tại sao cần bảng này?
Trước đó, bảng Transaction của mình chỉ ghi nhận dòng tiền (ví dụ: đóng phí).
Nhưng "Bồi thường" (Claim) không phải là một giao dịch đơn lẻ, nó là một quy trình (workflow) có nhiều trạng thái:
- Khách hàng nộp hồ sơ -> Trạng thái: "Mới nhận" (Submitted)
- Công ty xem xét, thẩm định -> Trạng thái: "Đang xử lý" (In Review)
- Công ty thấy thiếu giấy tờ -> Trạng thái: "Chờ bổ sung" (Pending Info)
- Công ty duyệt -> Trạng thái: "Đã duyệt" (Approved)
- Công ty từ chối -> Trạng thái: "Đã từ chối" (Rejected)
Bảng Transaction không thể lưu được quy trình này. Do đó cần một bảng Claim để quản lý "hồ sơ" (case file) của từng sự vụ bồi thường.
Tên cột
Kiểu dữ liệu
Khóa
Description
Claim_ID
INTEGER
PK (Khóa chính)
Mã định danh duy nhất cho hồ sơ bồi thường này.
Coverage_ID
INTEGER
FK
Cực kỳ quan trọng! Khách hàng đang đòi quyền lợi từ sản phẩm/quyền lợi nào? (Trỏ đến Coverage.Coverage_ID).
Event_Date
DATETIME

Ngày xảy ra sự kiện bảo hiểm (ngày tai nạn, ngày nhập viện).
Request_Date
DATETIME

Ngày khách hàng chính thức nộp hồ sơ yêu cầu.
Claim_Status
VARCHAR(50)

Trạng thái của quy trình (Submitted, Approved, Rejected...).
Requested_Amount
DECIMAL

Số tiền khách hàng yêu cầu bồi thường (có thể NULL).
Approved_Amount
DECIMAL

Số tiền công ty thực sự duyệt chi.
Description
TEXT

Ghi chú của khách hàng hoặc của nhân viên thẩm định (có thể NULL).
Payment_Date
DATETIME

Ngày công ty thanh toán tiền (sau khi duyệt). (có thể NULL).
Tại sao lại không gộp 2 db lại với nhau?
1. Lý do tại sao:
- Sai Mục đích Sử dụng:
  - Hệ thống Activity : Là một CSDL nội bộ (Back-office), ưu tiên tốc độ ghi/sửa (ví dụ: tạo request, thêm comment, đổi Status). Tần suất thấp (vài trăm/nghìn bản ghi mới mỗi ngày).
  - Hệ thống PAS: Là CSDL lõi nghiệp vụ (Core Business), ưu tiên tốc độ đọc và tính toàn vẹn 24/7. Tần suất cực cao (hàng triệu khách hàng, hàng chục triệu giao dịch).
- Ảnh hưởng nặng về Hiệu năng (Performance):
  - Hệ thống PAS có các bảng khổng lồ (ví dụ: bảng Policy, Transaction có thể lên đến hàng chục triệu dòng).
  - Khi gộp chung, mọi truy vấn đơn giản của AI Agent (ví dụ: SELECT * FROM Activity_Request) cũng phải chạy trên một CSDL khổng lồ, khiến nó chậm đi.
  - Điều tệ nhất: Nếu một truy vấn báo cáo (reporting) (ví dụ: "lấy tổng chi tiêu của ATO so với tổng doanh thu của PAS") vô tình khóa bảng (lock table) Policy hoặc Transaction trong vài giây, toàn bộ nghiệp vụ lõi của công ty sẽ bị đứng hình. Khách hàng không thể đóng phí, nhân viên không thể xử lý bồi thường.
- Rủi ro Bảo mật Khổng lồ:
  - Hệ thống PAS chứa dữ liệu cực kỳ nhạy cảm của khách hàng (thông tin cá nhân, sức khỏe).
  - Hệ thống Activity chỉ chứa dữ liệu chi tiêu nội bộ.
  - AI Agent (vốn chỉ cần duyệt chi tiêu) tự nhiên lại có quyền (hoặc ít nhất là có khả năng) đọc được dữ liệu sức khỏe của khách hàng. Đây là một cơn ác mộng về bảo mật.
2. Truy xuất của AI Agent sẽ bị chậm?
Nó sẽ phá vỡ hệ thống.
Như đã giải thích ở trên, AI Agent của mình là một AI Giao dịch (Transactional AI). Nó cần phản hồi ngay lập tức (real-time) để:
- Báo lỗi cho Sales Team ("Nhập quá 300k").
- Gửi tóm tắt cho sếp.
Nếu CSDL của nó bị gộp chung với CSDL PAS (hàng triệu dòng), tốc độ của nó sẽ chậm đi từ mili-giây thành vài giây (hoặc vài phút) cho mỗi thao tác. Quy trình của bạn sẽ "chết".
Mô tả chi tiết về PAS system này
1. Giải thích về các cột NULL và NOT NULL
Các cột BẮT BUỘC (Phải xóa dấu ?)
- Bảng Policy (Hợp đồng):
  - Policy_Number: Phải có. Số hợp đồng là định danh nghiệp vụ.
  - Party_ID: Phải có. Hợp đồng phải có chủ sở hữu.
  - Ngày_hiệu_lực: Phải có. Phải biết hợp đồng bắt đầu khi nào.
  - Status: Phải có. Phải biết trạng thái (đang chờ, hiệu lực, hủy...).
- Bảng Party (Đối tượng):
  - Name: Phải có. Phải biết tên khách hàng.
- Bảng Product (Sản phẩm):
  - Product_Code, Product_Name, Product_Type: Phải có. Đây là thông tin định danh cơ bản của sản phẩm.
- Bảng Coverage (Quyền lợi):
  - Policy_ID, Party_ID, Product_ID: Phải có. Quyền lợi phải thuộc 1 hợp đồng, bảo vệ 1 người, và là 1 sản phẩm cụ thể.
  - Sum_Assured: Phải có. Phải biết số tiền bảo hiểm là bao nhiêu.
- Bảng Transaction (Giao dịch):
  - Policy_ID, Loại_giao_dịch, Số_tiền, Ngày_giao_dịch: Phải có. Một giao dịch tài chính không thể thiếu 4 thông tin này.
- Bảng Claim (Bồi thường):
  - Coverage_ID: Phải có. Phải biết đang đòi bồi thường cho quyền lợi nào.
  - Request_Date: Phải có. Phải biết ngày nộp hồ sơ.
  - Claim_Status: Phải có. Phải biết trạng thái của hồ sơ.

---
Các cột TÙY CHỌN (Nên giữ dấu ?)
Đây là các giải thích chi tiết cho từng dấu ? mà bạn nên giữ lại:
- Policy.Ngày_đáo_hạn (?):
  - Lý do: Cho phép NULL (trống).
  - Ví dụ: Các sản phẩm "bảo hiểm trọn đời" (whole life) không có ngày đáo hạn cụ thể. Nó sẽ chỉ kết thúc khi người được bảo hiểm tử vong.
- Policy.Kỳ_đóng_phí (?):
  - Lý do: Cho phép NULL.
  - Ví dụ: Các sản phẩm đóng phí một lần (single premium). Khách hàng đóng 1 cục tiền duy nhất lúc ban đầu nên không có "kỳ" (hàng năm/quý/tháng) để theo dõi nữa.
- Policy.Campaign_Code (?):
  - Lý do: Cho phép NULL.
  - Ví dụ: Khách hàng tự tìm đến công ty (khách vãng lai) hoặc mua qua một kênh thông thường mà không đến từ một sự kiện/chiến dịch (Activity) cụ thể nào.
- Party.CCCD / Party.Email / Party.Phone_num (?):
  - Lý do: Cho phép NULL.
  - Ví dụ 1 (CCCD): Khách hàng là trẻ em (ví dụ: người được bảo hiểm trong hợp đồng của bố mẹ) chưa có CCCD.
  - Ví dụ 2 (Email/Phone): Khách hàng là người thụ hưởng (Beneficiary) mà người mua không có thông tin liên lạc chi tiết, hoặc khách hàng từ chối cung cấp email.
- Party.Role (?):
  - Lý do: Cho phép NULL.
  - Ví dụ: Cột này có thể dùng để đánh dấu các vai trò "đặc biệt" như "Đại lý", "Bác sĩ". Nếu là khách hàng thông thường (Bên mua, Người được bảo hiểm), vai trò của họ đã được thể hiện qua các khóa ngoại, nên cột Role này có thể để trống.
- Product.End_Date (?):
  - Lý do: Cho phép NULL.
  - Ví dụ: Sản phẩm vẫn đang được bán (Status = "Active") nên chưa có ngày kết thúc. Cột này chỉ được điền khi công ty quyết định "ngừng bán" (Discontinued) sản phẩm.
- Claim.Event_Date (?):
  - Lý do: Cho phép NULL.
  - Ví dụ: Khách hàng nộp hồ sơ yêu cầu "Đáo hạn hợp đồng" hoặc "Rút giá trị tài khoản". Các nghiệp vụ này không có "sự kiện bảo hiểm" (như tai nạn/ốm đau) xảy ra vào một ngày cụ thể.
- Claim.Requested_Amount (?):
  - Lý do: Cho phép NULL.
  - Ví dụ: Khách hàng nộp yêu cầu bồi thường thẻ sức khỏe (y tế). Họ chỉ nộp hóa đơn viện phí và không biết chính xác số tiền được duyệt là bao nhiêu. Họ để trống để công ty tự tính toán.
- Claim.Approved_Amount / Claim.Payment_Date (?):
  - Lý do: Cho phép NULL.
  - Ví dụ: Khi hồ sơ mới được nộp (Claim_Status = "Đang chờ xử lý"), dĩ nhiên là chưa có số tiền được duyệt và chưa có ngày thanh toán. Các cột này bắt buộc phải NULL cho đến khi hồ sơ được duyệt.
- Claim.Description (?):
  - Lý do: Cho phép NULL. Cột ghi chú là tùy chọn, không bắt buộc.

---
2. Quy trình Vận hành của CSDL (How it works)
CSDL này vận hành xoay quanh 2 quy trình nghiệp vụ chính: (A) Phát hành Hợp đồng và (B) Xử lý Bồi thường.
A. Kịch bản Vận hành 1: Phát hành Hợp đồng mới
1. Tạo Đối tượng (Party):
  - Sales Team gặp khách hàng (Nguyễn Văn A). Hệ thống INSERT một dòng mới vào Party (Chủ sở hữu).
  - Anh A mua cho con là bé B. Hệ thống INSERT một dòng Party thứ hai (Người được bảo hiểm).
2. Tạo Hợp đồng (Policy):
  - Hệ thống INSERT một dòng vào Policy.
  - Policy.Party_ID sẽ trỏ đến Party_ID của anh A (chủ sở hữu).
  - Nếu anh A mua từ một sự kiện -> Policy.Campaign_Code = 'HCM_1225'.
3. Tạo Quyền lợi (Coverage):
  - Anh A mua 1 sản phẩm chính (tra cứu từ Product) và 2 sản phẩm bổ trợ (cũng tra cứu từ Product).
  - Hệ thống INSERT 3 dòng mới vào Coverage. Cả 3 dòng:
    - Cùng Policy_ID (thuộc hợp đồng của anh A).
    - Cùng Party_ID (trỏ đến Party_ID của bé B - người được bảo hiểm).
    - Có 3 Product_ID khác nhau (tương ứng 3 sản phẩm đã mua).
4. Ghi nhận Thanh toán (Transaction):
  - Anh A đóng phí lần đầu.
  - Hệ thống INSERT 1 dòng vào Transaction (Loại = "Đóng phí lần đầu").
5. Kích hoạt: Hệ thống UPDATE Policy.Status = "Đang hiệu lực".
B. Kịch bản Vận hành 2: Xử lý Bồi thường
1. Yêu cầu Bồi thường (Claim):
  - Một năm sau, bé B (người được bảo hiểm) không may phải nằm viện, sử dụng quyền lợi thẻ sức khỏe (ví dụ: Coverage_ID = 101).
  - Anh A nộp hồ sơ (hóa đơn viện phí).
  - Hệ thống INSERT 1 dòng vào Claim (gán Coverage_ID = 101, Claim_Status = "Đang chờ xử lý").
2. Thẩm định & Phê duyệt:
  - Nhân viên thẩm định (Claim Adjuster) xem xét hồ sơ.
  - Họ quyết định duyệt chi trả 5 triệu.
  - Hệ thống UPDATE dòng Claim đó:
    - Claim_Status = "Đã duyệt"
    - Approved_Amount = 5,000,000
3. Kích hoạt Giao dịch (Transaction):
  - Hệ thống (hoặc Kế toán) thực hiện chuyển tiền.
  - Hệ thống UPDATE Claim.Payment_Date = (ngày hôm nay).
  - Đồng thời, hệ thống tự động INSERT 1 dòng mới vào Transaction (Loại = "Chi trả bồi thường", Số_tiền = 5,000,000).
