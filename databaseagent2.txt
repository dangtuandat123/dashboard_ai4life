-- Tạo kiểu ENUM
CREATE TYPE role_enum AS ENUM (
  'Sales',
  'Sales_Manager',
  'Marketing_Staff',
  'Finance_Controller'
);

CREATE TYPE request_status_enum AS ENUM (
  'Bản nháp',
  'Chờ sếp ATO duyệt',
  'Chờ Marketing duyệt',
  'Chờ Tài chính duyệt',
  'Đã duyệt',
  'Bị từ chối'
);

-- -----------------------------------------------------
-- Bảng department (Phòng ban)
-- -----------------------------------------------------
CREATE TABLE department (
    department_id   INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    department_name VARCHAR(255) NOT NULL
);
COMMENT ON TABLE department IS 'Định nghĩa các phòng ban tham gia quy trình';
COMMENT ON COLUMN department.department_name IS 'Tên phòng ban, vd: "ATO ‑ Vùng 1", "Marketing", "Tài chính"';

-- -----------------------------------------------------
-- Bảng policy_rule (Quy định/Định mức của Công ty)
-- -----------------------------------------------------
CREATE TABLE policy_rule (
    rule_id     INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    rule_name   VARCHAR(255) NOT NULL UNIQUE,
    rule_value  VARCHAR(255),
    description TEXT
);
COMMENT ON TABLE policy_rule IS 'Bộ não tham chiếu cho AI Agent khi tiền thẩm định';
COMMENT ON COLUMN policy_rule.rule_name IS 'Tên quy định, vd: "Định mức quà tặng"';
COMMENT ON COLUMN policy_rule.rule_value IS 'Giá trị, vd: "300000"';
COMMENT ON COLUMN policy_rule.description IS 'Mô tả, vd: "Chi phí quà tặng không quá 300.000 VNĐ/khách"';

-- -----------------------------------------------------
-- Bảng employee (Nhân viên)
-- -----------------------------------------------------
CREATE TABLE employee (
    employee_id   INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    full_name     VARCHAR(255) NOT NULL,
    email         VARCHAR(255) NOT NULL UNIQUE,
    department_id INT,
    manager_id    INT,
    role          role_enum
);
COMMENT ON TABLE employee IS 'Lưu trữ thông tin của tất cả người dùng hệ thống';
COMMENT ON COLUMN employee.full_name IS 'Tên đầy đủ';
COMMENT ON COLUMN employee.email IS 'Dùng để gửi thông báo';
COMMENT ON COLUMN employee.role IS 'Vai trò, vd: Sales, Sales_Manager, Marketing_Staff, Finance_Controller';

ALTER TABLE employee
    ADD CONSTRAINT fk_employee_department
        FOREIGN KEY (department_id) REFERENCES department(department_id),
    ADD CONSTRAINT fk_employee_manager
        FOREIGN KEY (manager_id)    REFERENCES employee(employee_id);

-- -----------------------------------------------------
-- Bảng annual_budget ("Cái ví tổng" đã duyệt)
-- -----------------------------------------------------
CREATE TABLE annual_budget (
    annual_budget_id   INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    department_id       INT,
    year                INT NOT NULL,
    category            VARCHAR(255) NOT NULL,
    total_amount        NUMERIC(19,2) NOT NULL,
    amount_spent        NUMERIC(19,2) NOT NULL DEFAULT 0.00,
    amount_remaining    NUMERIC(19,2)
);
COMMENT ON TABLE annual_budget IS 'Bảng "sổ cái" mà Tài chính dùng để kiểm tra ngân sách';
COMMENT ON COLUMN annual_budget.year IS 'Năm, vd: 2026';
COMMENT ON COLUMN annual_budget.category IS 'Hạng mục, vd: "Hội thảo khách hàng"';
COMMENT ON COLUMN annual_budget.total_amount IS 'Tổng tiền được duyệt';
COMMENT ON COLUMN annual_budget.amount_spent IS 'Số tiền đã tiêu';
COMMENT ON COLUMN annual_budget.amount_remaining IS 'Số tiền còn lại';

ALTER TABLE annual_budget
    ADD CONSTRAINT fk_annualbudget_department
        FOREIGN KEY (department_id) REFERENCES department(department_id);

-- -----------------------------------------------------
-- Bảng activity_request (Đề xuất Hoạt động)
-- -----------------------------------------------------
CREATE TABLE activity_request (
    request_id                INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    request_name              VARCHAR(255) NOT NULL,
    requestor_id              INT,
    request_date              TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    event_date                TIMESTAMP,
    total_budget_requested    NUMERIC(19,2),
    status                    request_status_enum DEFAULT 'Bản nháp',
    annual_budget_id          INT,
    campaign_code             VARCHAR(100)
);
COMMENT ON TABLE activity_request IS 'Bảng "giao dịch" chính, lưu mỗi "yêu cầu xin kinh phí"';
COMMENT ON COLUMN activity_request.request_name IS 'Tên sự kiện, vd: "Hội thảo Sống Khỏe TPHCM 12/2026"';
COMMENT ON COLUMN activity_request.total_budget_requested IS 'Tổng kinh phí xin';
COMMENT ON COLUMN activity_request.status IS 'Trạng thái: Bản nháp, Chờ sếp ATO duyệt, …';

ALTER TABLE activity_request
    ADD CONSTRAINT fk_ar_requestor
        FOREIGN KEY (requestor_id)     REFERENCES employee(employee_id),
    ADD CONSTRAINT fk_ar_annualbudget
        FOREIGN KEY (annual_budget_id)  REFERENCES annual_budget(annual_budget_id);

-- -----------------------------------------------------
-- Bảng budget_item (Chi tiết các Hạng mục chi)
-- -----------------------------------------------------
CREATE TABLE budget_item (
    item_id            INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    request_id         INT NOT NULL,
    item_name          VARCHAR(255) NOT NULL,
    description        TEXT,
    requested_amount   NUMERIC(19,2) NOT NULL,
    vendor_quote_link  VARCHAR(2000)
);
COMMENT ON TABLE budget_item IS 'Lưu các dòng chi tiết trong file Excel dự toán';
COMMENT ON COLUMN budget_item.item_name IS 'Hạng mục, vd: "Thuê địa điểm", "Tea‑break"';
COMMENT ON COLUMN budget_item.vendor_quote_link IS 'Link đến báo giá của nhà cung cấp';

ALTER TABLE budget_item
    ADD CONSTRAINT fk_bi_request
        FOREIGN KEY (request_id) REFERENCES activity_request(request_id) ON DELETE CASCADE;

-- -----------------------------------------------------
-- Bảng document (Tài liệu đính kèm)
-- -----------------------------------------------------
CREATE TABLE document (
    document_id       INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    request_id        INT NOT NULL,
    file_name         VARCHAR(255) NOT NULL,
    file_path         VARCHAR(2000) NOT NULL,
    uploaded_by_id    INT,
    upload_timestamp  TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
COMMENT ON TABLE document IS 'Nơi lưu trữ các file mềm (PowerPoint kế hoạch, Excel...)';
COMMENT ON COLUMN document.file_path IS 'Đường dẫn lưu file trên server/cloud';

ALTER TABLE document
    ADD CONSTRAINT fk_doc_request
        FOREIGN KEY (request_id)      REFERENCES activity_request(request_id) ON DELETE CASCADE,
    ADD CONSTRAINT fk_doc_uploaded_by
        FOREIGN KEY (uploaded_by_id)   REFERENCES employee(employee_id);

-- -----------------------------------------------------
-- Bảng approval_workflow (Lịch sử Luồng Phê duyệt)
-- -----------------------------------------------------
CREATE TABLE approval_workflow (
    step_id         INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    request_id      INT NOT NULL,
    step_number     INT,
    approver_id     INT,
    status          VARCHAR(50) DEFAULT 'Pending',
    comment         TEXT,
    action_timestamp TIMESTAMP
);
COMMENT ON TABLE approval_workflow IS 'Bảng "ghi lại nhật ký" của toàn bộ quy trình';
COMMENT ON COLUMN approval_workflow.step_number IS 'Thứ tự bước, vd: 1, 2, 3';
COMMENT ON COLUMN approval_workflow.status IS 'Trạng thái của bước này: "Pending", "Approved", "Rejected"';

ALTER TABLE approval_workflow
    ADD CONSTRAINT fk_aw_request
        FOREIGN KEY (request_id)  REFERENCES activity_request(request_id) ON DELETE CASCADE,
    ADD CONSTRAINT fk_aw_approver
        FOREIGN KEY (approver_id) REFERENCES employee(employee_id);



