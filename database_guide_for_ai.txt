# HƯỚNG DẪN SỬ DỤNG DATABASE CHO AI AGENT (BEEBOX INTELLIGENCE)

Tài liệu này mô tả chi tiết cấu trúc Database (PostgreSQL/Supabase) của hệ thống BeeBox Intelligence. AI Agent cần đọc kỹ để hiểu ngữ nghĩa dữ liệu và trả lời các câu hỏi từ Dashboard (tính năng Click-to-Prompt).

---

## 1. TỔNG QUAN HỆ THỐNG
Hệ thống gồm 2 phân hệ dữ liệu chính:
1.  **Agent 1 (PAS - Policy Administration System):** Quản lý bảo hiểm, doanh thu, khách hàng, hợp đồng. Dữ liệu này dùng để phân tích **Hiệu suất (Performance)** và **Doanh thu (Revenue)**.
2.  **Agent 2 (Budget & Operation):** Quản lý nhân sự, phòng ban, ngân sách và quy trình phê duyệt chi tiêu. Dữ liệu này dùng để phân tích **Chi phí (Cost)**, **Lợi nhuận (Profit)** và **Tuân thủ ngân sách**.

---

## 2. CHI TIẾT BẢNG DỮ LIỆU (SCHEMA)

### A. PHÂN HỆ AGENT 2: QUẢN TRỊ & NGÂN SÁCH (Budget & Org)

#### 1. `department` (Phòng ban)
*   **Mô tả:** Danh sách các phòng ban trong công ty.
*   **Cột:**
    *   `department_id`: ID phòng ban.
    *   `department_name`: Tên phòng ban (VD: Sales, Marketing, IT).
*   **Sử dụng:** Dùng để group doanh thu/chi phí theo phòng ban.

#### 2. `employee` (Nhân viên)
*   **Mô tả:** Thông tin nhân viên, bao gồm cả các chỉ số hiệu suất cá nhân (được cập nhật từ Agent 1).
*   **Cột:**
    *   `employee_id`: ID nhân viên.
    *   `full_name`: Tên đầy đủ.
    *   `department_id`: Thuộc phòng ban nào.
    *   `manager_id`: ID người quản lý trực tiếp.
    *   `role`: Vai trò (VD: Sales Agent, Manager).
    *   `leads_count`: Số lượng lead đang phụ trách (KPI).
    *   `revenue`: Tổng doanh thu mang về (KPI quan trọng).
*   **Sử dụng:** Khi người dùng hỏi "Ai là nhân viên xuất sắc nhất?", hãy query bảng này, sort theo `revenue DESC`.

#### 3. `annual_budget` (Ngân sách năm)
*   **Mô tả:** Ngân sách được cấp cho từng phòng ban theo năm.
*   **Cột:**
    *   `total_amount`: Tổng ngân sách được cấp.
    *   `amount_spent`: Số tiền đã chi tiêu thực tế.
    *   `amount_remaining`: Số tiền còn lại (Tự động tính: Total - Spent).
*   **Sử dụng:** Rất quan trọng cho câu hỏi về **Rủi ro tài chính**.
    *   *Ví dụ:* Nếu user hỏi về "Chi phí", hãy check `amount_remaining`. Nếu < 0 hoặc thấp, hãy cảnh báo "Vượt ngân sách".

#### 4. `request` & `budget_item` (Yêu cầu chi tiêu)
*   **Mô tả:** Các yêu cầu chi tiền từ nhân viên (VD: Tổ chức sự kiện, mua thiết bị).
*   **Sử dụng:** Dùng để giải thích **"Tại sao chi phí tháng này cao?"**. Hãy tìm các request có `status = 'Approved'` và `total_estimated_amount` lớn trong tháng đó.

---

### B. PHÂN HỆ AGENT 1: KINH DOANH BẢO HIỂM (Sales & Insurance)

#### 1. `product` (Sản phẩm)
*   **Mô tả:** Các gói bảo hiểm công ty cung cấp.
*   **Cột quan trọng:**
    *   `product_category`: Nhóm sản phẩm (VD: Sức khỏe, Xe cơ giới, Tài sản). Dùng để vẽ biểu đồ "Doanh thu theo dòng sản phẩm".
    *   `product_type`: Loại chi tiết.

#### 2. `party` (Khách hàng & Pipeline)
*   **Mô tả:** Lưu thông tin khách hàng và **trạng thái trong phễu bán hàng (Pipeline)**.
*   **Cột quan trọng:**
    *   `pipeline_stage`: Giai đoạn hiện tại. Các giá trị: 'Leads mới' -> 'Đang tư vấn' -> 'Đang chốt' -> 'Thẩm định' -> 'Phát hành'.
    *   `sales_channel`: Kênh tiếp cận (VD: Hội thảo, Tư vấn 1-1).
*   **Sử dụng:**
    *   Khi user hỏi về **Pipeline**: Đếm số lượng `party_id` group by `pipeline_stage`.
    *   Gợi ý hành động: Nếu nhiều khách ở 'Đang chốt', gợi ý "Tập trung closing để tăng doanh thu tháng".

#### 3. `policy` (Hợp đồng bảo hiểm)
*   **Mô tả:** Hợp đồng đã phát hành cho khách hàng.
*   **Cột quan trọng:**
    *   `effective_date`: Ngày hiệu lực (Dùng để tính doanh thu theo tháng).
    *   `status`: Trạng thái hợp đồng.

#### 4. `transaction` (Giao dịch tài chính - QUAN TRỌNG NHẤT)
*   **Mô tả:** Bảng trung tâm ghi nhận dòng tiền vào (Doanh thu) và ra (Chi phí).
*   **Cột:**
    *   `amount`: Số tiền.
    *   `transaction_date`: Ngày giao dịch.
    *   `is_cost`:
        *   `FALSE`: Là Doanh thu (Tiền phí bảo hiểm thu được).
        *   `TRUE`: Là Chi phí (Chi bồi thường, chi vận hành, hoa hồng).
*   **Sử dụng:**
    *   Tính **Lợi nhuận ròng (Net Profit)** = Sum(Amount where is_cost=False) - Sum(Amount where is_cost=True).
    *   Phân tích xu hướng tài chính theo thời gian.

---

## 3. CHIẾN LƯỢC TRẢ LỜI "CLICK-TO-PROMPT" (Dành cho AI)

Khi người dùng click vào Dashboard, hệ thống sẽ gửi một prompt dạng:
`"Mình đang xem dashboard BeeBox, mục [Title]: [Value]. Hãy phân tích..."`

Dưới đây là cách AI map từ ngữ cảnh sang SQL Query để trả lời sâu sắc:

### Tình huống 1: Click vào "KPI Tháng" hoặc "Hiệu suất tài chính"
*   **Câu hỏi tiềm ẩn:** "Tại sao doanh thu lại là con số này? Có tốt không? Có rủi ro gì không?"
*   **Hành động của AI:**
    1.  Query bảng `transaction` trong tháng hiện tại để lấy chi tiết Revenue và Cost.
    2.  Query bảng `annual_budget` để so sánh Cost với ngân sách.
    3.  **Trả lời:**
        *   "Doanh thu đạt X tỷ, chủ yếu đến từ dòng sản phẩm [Product Category] (Query bảng `product` join `coverage`)."
        *   "Tuy nhiên, chi phí đang chiếm Y% doanh thu. Cảnh báo: Ngân sách phòng Marketing chỉ còn Z triệu (Query `annual_budget`)."

### Tình huống 2: Click vào "Pipeline" hoặc "Giai đoạn nóng"
*   **Câu hỏi tiềm ẩn:** "Khách hàng đang kẹt ở đâu? Làm sao để bán được nhiều hơn?"
*   **Hành động của AI:**
    1.  Query bảng `party`: `SELECT pipeline_stage, COUNT(*) FROM party GROUP BY pipeline_stage`.
    2.  Tính tỷ lệ chuyển đổi giữa các bước.
    3.  **Trả lời:**
        *   "Hiện có 50 khách hàng đang ở bước 'Thẩm định'. Đây là điểm nghẽn. Hãy kiểm tra lại quy trình duyệt hồ sơ."
        *   "Kênh 'Hội thảo' đang mang lại nhiều leads nhất (Query `sales_channel`), hãy đẩy mạnh ngân sách cho kênh này."

### Tình huống 3: Click vào "Top Performers" (Nhân viên xuất sắc)
*   **Câu hỏi tiềm ẩn:** "Ai đang gánh team? Ai cần hỗ trợ?"
*   **Hành động của AI:**
    1.  Query bảng `employee`: `SELECT full_name, revenue, leads_count FROM employee ORDER BY revenue DESC`.
    2.  **Trả lời:**
        *   "Nguyễn Văn A đang dẫn đầu với doanh thu X tỷ. Tuy nhiên, nhân viên B có nhiều leads nhưng doanh thu thấp -> Cần training thêm kỹ năng chốt sale cho B."

---

## 4. CÁC VIEW QUAN TRỌNG (Đã tạo sẵn trong DB)
AI có thể select trực tiếp từ các view này để lấy số liệu tổng hợp nhanh:
*   `v_financial_data`: Tổng hợp Revenue/Cost theo tháng (cho biểu đồ tài chính).
*   `v_pipeline_stages`: Đếm số lượng khách theo giai đoạn phễu.
*   `v_top_performers_heatmap`: Top nhân viên theo doanh thu & hoạt động.
*   `v_product_lines`: Doanh thu theo nhóm sản phẩm.
*   `v_sales_quantity`: Số lượng hợp đồng đã bán theo loại sản phẩm.

**Lưu ý:** Khi cần phân tích nguyên nhân gốc rễ (Root Cause Analysis), hãy query vào bảng gốc (`transaction`, `party`, `request`) thay vì chỉ nhìn vào View.
